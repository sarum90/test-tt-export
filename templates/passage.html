{% extends "base.html" %}

{% block title %}{{ passage_meta.name }} - {{ site_title }}{% endblock %}
{% block description %}{{ passage_meta.description or site_description }}{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<nav class="breadcrumb">
    <a href="{{ base_url }}passages/">Passages</a>
    <span class="sep">/</span>
    <span class="current">{{ passage_meta.name }}</span>
</nav>

<!-- Intro Content -->
{% if passage_meta.intro_html %}
<div class="prose mb-6">
    {{ passage_meta.intro_html | safe }}
</div>
{% endif %}

<!-- Audio Player -->
{% if audio_urls %}
<div class="audio-container card card-padding">
    <audio controls preload="metadata">
        <source src="{{ base_url }}{{ audio_urls.streaming }}">
        Your browser does not support audio playback.
    </audio>
    <div class="audio-downloads mt-2">
        <span class="text-sm text-muted">Download:</span>
        <a href="{{ base_url }}{{ audio_urls.streaming }}" download class="text-sm">MP3 <span class="text-muted">(lossy, {{ audio_urls.streaming_size }})</span></a>
        {% if audio_urls.lossless %}
        <a href="{{ base_url }}{{ audio_urls.lossless }}" download class="text-sm">FLAC <span class="text-muted">(lossless, {{ audio_urls.lossless_size }})</span></a>
        {% endif %}
        {% if audio_urls.original %}
        <a href="{{ base_url }}{{ audio_urls.original }}" download class="text-sm">Original <span class="text-muted">({{ audio_urls.original_size }})</span></a>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Sentences -->
<div class="space-y-4">
    {% set valid_sentences = get_valid_sentences(passage) %}
    {% for sentence in valid_sentences %}
    {% set grammatical_class = "" %}
    {% if not sentence.grammatical %}{% set grammatical_class = grammatical_class + " ungrammatical" %}{% endif %}
    {% if sentence.infelicitous %}{% set grammatical_class = grammatical_class + " infelicitous" %}{% endif %}

    <div id="sentence-{{ loop.index }}" class="sentence-block{{ grammatical_class }}">
        <!-- Sentence number -->
        <div class="sentence-number"><a href="#sentence-{{ loop.index }}">({{ loop.index }})</a></div>

        <!-- Interlinear gloss grid -->
        {% set word_count = sentence.word_tracks[0].words | length %}
        <div class="interlinear-grid">
            {% for word_idx in range(word_count) %}
            <div class="word-column">
                {% for track in sentence.word_tracks %}
                {% set word = track.words[word_idx] or '' %}
                {% if track.name in ['IPA', 'Phonetic'] %}
                <span class="ipa-text">{{ word | superscripts | safe }}</span>
                {% else %}
                <span class="gloss-text">{{ word | superscripts | safe }}</span>
                {% endif %}
                {% endfor %}
            </div>
            {% endfor %}
        </div>

        <!-- Sentence-level translations -->
        {% for track in sentence.sentence_tracks or [] %}
        <div class="translation">
            {{ track.sentence }}
        </div>
        {% endfor %}
    </div>
    {% endfor %}
</div>

<!-- Navigation -->
<div class="back-link">
    <a href="{{ base_url }}passages/">&larr; Back to Passages</a>
</div>
{% endblock %}
