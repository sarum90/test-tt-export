{% extends "base.html" %}

{% block title %}{{ passage_meta.name }} - {{ site_title }}{% endblock %}
{% block description %}{{ passage_meta.description or site_description }}{% endblock %}

{% block content %}
<div x-data="viewOptions()" x-cloak>

<!-- Breadcrumb -->
<nav class="breadcrumb">
    <a href="{{ base_url }}passages/">Passages</a>
    <span class="sep">/</span>
    <span class="current">{{ passage_meta.name }}</span>
</nav>

<!-- Intro Content -->
{% if passage_meta.intro_html %}
{{ passage_meta.intro_html | safe }}
{% endif %}

<!-- View Options -->
{% if available_tracks %}
<div class="view-options card card-padding mb-4">
    <span class="view-options-label">{{ t('view.show_hide') }}</span>
    <div class="view-options-controls">
        {% for track_name in available_tracks %}
        <label class="view-option">
            <input type="checkbox" x-model="show.{{ track_name }}">
            <span>{{ track_name }}</span>
        </label>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Sentences -->
<div class="space-y-4">
    {% set valid_sentences = get_valid_sentences(passage) %}
    {% for sentence in valid_sentences %}
    {% set grammatical_class = "" %}
    {% if not sentence.grammatical %}{% set grammatical_class = grammatical_class + " ungrammatical" %}{% endif %}
    {% if sentence.infelicitous %}{% set grammatical_class = grammatical_class + " infelicitous" %}{% endif %}

    <div id="sentence-{{ loop.index }}" class="sentence-block{{ grammatical_class }}">
        <!-- Sentence number -->
        <div class="sentence-number"><a href="#sentence-{{ loop.index }}">({{ loop.index }})</a></div>

        <!-- Interlinear gloss grid (only if word tracks present) -->
        {% if sentence.word_tracks and sentence.word_tracks[0].words %}
        {% set word_count = sentence.word_tracks[0].words | length %}
        <div class="interlinear-grid">
            {% for word_idx in range(word_count) %}
            <div class="word-column">
                {% for track in sentence.word_tracks %}
                {% set word = track.words[word_idx] or '' %}
                {% if track.name in ['IPA', 'Phonetic'] %}
                <span class="ipa-text" x-show="show.{{ track.name }}">{{ word | superscripts | safe }}</span>
                {% else %}
                <span class="gloss-text" x-show="show.{{ track.name }}">{{ word | superscripts | safe }}</span>
                {% endif %}
                {% endfor %}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Sentence-level translations -->
        {% for track in sentence.sentence_tracks or [] %}
        <div class="translation" x-show="show.{{ track.name }}">
            {{ track.sentence }}
        </div>
        {% endfor %}
    </div>
    {% endfor %}
</div>

<!-- Navigation -->
<div class="back-link">
    <a href="{{ base_url }}passages/">&larr; {{ t('passage.back') }}</a>
</div>

</div><!-- end x-data -->
{% endblock %}

{% block scripts %}
<script>
function viewOptions() {
    const key = 'viewOptions';
    const stored = localStorage.getItem(key);
    const availableTracks = {{ available_tracks | tojson }};
    // Default all available tracks to visible
    const defaults = {};
    availableTracks.forEach(t => defaults[t] = true);
    const initial = stored ? { ...defaults, ...JSON.parse(stored) } : defaults;

    return {
        show: initial,
        init() {
            this.$watch('show', (val) => {
                localStorage.setItem(key, JSON.stringify(val));
            });
        }
    };
}
</script>
{% endblock %}
